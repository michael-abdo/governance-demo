name: Dependency Audit

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'requirements.txt'
      - 'Pipfile'
      - 'Pipfile.lock'

permissions:
  contents: read
  pull-requests: write

jobs:
  audit-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit
        id: audit
        continue-on-error: true
        run: |
          npm audit --json > audit_results.json 2>&1
          VULN_COUNT=$(jq '.metadata.vulnerabilities.total // 0' audit_results.json)
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit_results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit_results.json)

          echo "total=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

      - name: Check for new dependencies
        id: newdeps
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # Compare package.json dependencies
          NEW_DEPS=$(diff \
            <(git show origin/${{ github.base_ref }}:package.json | jq -r '.dependencies // {} | keys[]' 2>/dev/null | sort) \
            <(jq -r '.dependencies // {} | keys[]' package.json | sort) \
            | grep "^>" | sed 's/^> //' || true)

          NEW_DEV_DEPS=$(diff \
            <(git show origin/${{ github.base_ref }}:package.json | jq -r '.devDependencies // {} | keys[]' 2>/dev/null | sort) \
            <(jq -r '.devDependencies // {} | keys[]' package.json | sort) \
            | grep "^>" | sed 's/^> //' || true)

          if [ -n "$NEW_DEPS" ] || [ -n "$NEW_DEV_DEPS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "deps=$NEW_DEPS" >> $GITHUB_OUTPUT
            echo "devdeps=$NEW_DEV_DEPS" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Post audit comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOTAL=${{ steps.audit.outputs.total }}
          CRITICAL=${{ steps.audit.outputs.critical }}
          HIGH=${{ steps.audit.outputs.high }}
          NEW_FOUND=${{ steps.newdeps.outputs.found }}

          STATUS="PASS"
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            STATUS="FAIL"
          fi

          COMMENT="## Dependency Audit Report

          **Status:** ${STATUS}
          **Vulnerabilities:** ${TOTAL} total (${CRITICAL} critical, ${HIGH} high)
          "

          if [ "$NEW_FOUND" = "true" ]; then
            COMMENT="${COMMENT}
          > **NEW DEPENDENCIES ADDED** - Review these packages before approving:
          > Production: ${{ steps.newdeps.outputs.deps }}
          > Dev: ${{ steps.newdeps.outputs.devdeps }}
          "
          fi

          if [ "$STATUS" = "FAIL" ]; then
            COMMENT="${COMMENT}

          **ACTION REQUIRED:** Critical or high severity vulnerabilities found. Run \`npm audit\` locally for details. Do not merge until resolved."
          fi

          echo "$COMMENT" > audit_comment.md
          gh pr comment ${{ github.event.pull_request.number }} --body-file audit_comment.md
