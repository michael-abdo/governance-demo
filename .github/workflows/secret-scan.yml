name: Secret and Credential Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for hardcoded secrets
        id: scan
        run: |
          # Patterns that should never appear in code
          # Uses [=:] to catch both assignment (=) and object/dict/YAML (:) syntax
          PATTERNS=(
            'ANTHROPIC_API_KEY\s*[=:]\s*["\x27]sk-'
            'OPENAI_API_KEY\s*[=:]\s*["\x27]sk-'
            'AWS_SECRET_ACCESS_KEY\s*[=:]\s*["\x27][A-Za-z0-9/+=]{40}'
            'ZOOM_SECRET\s*[=:]\s*["\x27]'
            'DATABASE_URL\s*[=:]\s*["\x27]postgres'
            'REDIS_URL\s*[=:]\s*["\x27]redis'
            'JWT_SECRET\s*[=:]\s*["\x27]'
            'HUME_API_KEY\s*[=:]\s*["\x27]'
            'password\s*[=:]\s*["\x27][^"'\'']{8,}'
            'private_key\s*[=:]\s*["\x27]'
            'BEGIN RSA PRIVATE KEY'
            'BEGIN OPENSSH PRIVATE KEY'
            'BEGIN EC PRIVATE KEY'
          )

          FINDINGS=""
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(git diff origin/${{ github.base_ref }}...HEAD -- . ':!*.lock' ':!node_modules' | grep -inE "$pattern" || true)
            if [ -n "$MATCHES" ]; then
              FINDINGS="${FINDINGS}\nPattern: ${pattern}\n${MATCHES}\n"
            fi
          done

          if [ -n "$FINDINGS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo -e "$FINDINGS" > secret_findings.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for .env files in diff
        id: envcheck
        run: |
          ENV_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.env($|\.)' | grep -v '\.env\.example' || true)
          if [ -n "$ENV_FILES" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "$ENV_FILES" > env_files.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Block PR if secrets found
        if: steps.scan.outputs.found == 'true' || steps.envcheck.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "## BLOCKED: Potential Secrets Detected"
            echo ""
            echo "This PR has been flagged for containing what appear to be hardcoded credentials or secret files."
            echo ""
            echo "**DO NOT MERGE** until these are resolved."
          } > secret_comment.md

          if [ "${{ steps.scan.outputs.found }}" = "true" ]; then
            echo "" >> secret_comment.md
            echo "**Hardcoded credentials detected.** Remove them and use environment variables or GitHub Secrets instead." >> secret_comment.md
            echo "" >> secret_comment.md
            echo "Findings:" >> secret_comment.md
            echo '```' >> secret_comment.md
            cat secret_findings.txt >> secret_comment.md
            echo '```' >> secret_comment.md
          fi

          if [ "${{ steps.envcheck.outputs.found }}" = "true" ]; then
            ENV_LIST=$(cat env_files.txt)
            echo "" >> secret_comment.md
            echo "**Environment files in PR:** ${ENV_LIST}" >> secret_comment.md
            echo "These should be in .gitignore, not committed to the repository." >> secret_comment.md
          fi

          gh pr comment ${{ github.event.pull_request.number }} --body-file secret_comment.md
          gh pr edit ${{ github.event.pull_request.number }} --add-label "blocked-secrets"
          exit 1

      - name: Clean scan
        if: steps.scan.outputs.found == 'false' && steps.envcheck.outputs.found == 'false'
        run: echo "No secrets detected. Scan passed."
