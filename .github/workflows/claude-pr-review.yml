name: Claude AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          echo "diff_size=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Check diff size
        id: check
        run: |
          DIFF_SIZE=${{ steps.diff.outputs.diff_size }}
          if [ "$DIFF_SIZE" -gt 100000 ]; then
            echo "oversized=true" >> $GITHUB_OUTPUT
            echo "WARNING: Diff exceeds 100KB. Truncating for review."
            head -c 100000 pr_diff.txt > pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
          else
            echo "oversized=false" >> $GITHUB_OUTPUT
          fi

      - name: Get changed file list
        id: files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' > changed_files.txt
          cat changed_files.txt

      - name: Check for sensitive files
        id: sensitive
        run: |
          SENSITIVE_PATTERNS="\.env|secrets|auth/|middleware/auth|migrations/|docker-compose|Dockerfile|package\.json|requirements\.txt|\.lock$|CODEOWNERS|\.github/workflows"
          SENSITIVE_FILES=$(grep -E "$SENSITIVE_PATTERNS" changed_files.txt || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "$SENSITIVE_FILES" > sensitive_files.txt
            echo "SENSITIVE FILES DETECTED:"
            cat sensitive_files.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Send to Claude API for review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Build user message content safely via file (avoids shell injection from diff content)
          {
            printf "PR: %s\n" "${{ github.event.pull_request.title }}"
            printf "Author: %s\n" "${{ github.event.pull_request.user.login }}"
            printf "Description: %s\n" "${{ github.event.pull_request.body }}"
          } > user_message.txt

          # Append sensitive file warning if needed
          if [ "${{ steps.sensitive.outputs.found }}" = "true" ]; then
            printf "\nCRITICAL: This PR touches sensitive files that require owner review:\n" >> user_message.txt
            cat sensitive_files.txt >> user_message.txt
          fi

          if [ "${{ steps.check.outputs.oversized }}" = "true" ]; then
            printf "\nWARNING: This diff was truncated because it exceeds 100KB. The review may be incomplete.\n" >> user_message.txt
          fi

          printf "\nChanged files:\n" >> user_message.txt
          cat changed_files.txt >> user_message.txt

          printf "\nDiff:\n" >> user_message.txt
          cat pr_diff.txt >> user_message.txt

          # Build JSON payload using jq with --rawfile to avoid shell injection
          jq -n \
            --arg model "claude-sonnet-4-5-20250929" \
            --arg system "You are a senior code reviewer for XcellerateEQ, an AI-powered meeting analytics platform. Your job is to review pull request diffs and provide actionable, specific feedback.

          REVIEW PRIORITIES (in order):
          1. SECURITY: Hardcoded secrets, SQL injection, XSS, auth bypasses, data exposure
          2. ARCHITECTURE: Does this align with the existing codebase patterns? Any unnecessary complexity?
          3. DATA INTEGRITY: Database migrations, data loss risks, race conditions
          4. LOGIC ERRORS: Off-by-one, null handling, edge cases, error handling gaps
          5. PERFORMANCE: N+1 queries, memory leaks, unnecessary re-renders
          6. CODE QUALITY: Naming, readability, test coverage gaps

          RESPONSE FORMAT:
          Start with a severity summary: CRITICAL / WARNING / CLEAN
          Then list findings grouped by category above.
          For each finding, reference the specific file and line context.
          End with a one-line verdict: APPROVE, REQUEST CHANGES, or NEEDS DISCUSSION.

          If sensitive files (auth, migrations, env, dependencies) are touched, always flag them prominently.
          Be direct. No filler. Prioritize issues by impact." \
            --rawfile content user_message.txt \
            '{
              model: $model,
              max_tokens: 4096,
              system: $system,
              messages: [{role: "user", content: $content}]
            }' > payload.json

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d @payload.json)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "API call failed with status $HTTP_CODE"
            echo "$BODY"
            echo "Claude API review failed (HTTP $HTTP_CODE). Manual review required." > review_output.txt
          else
            echo "$BODY" | jq -r '.content[0].text' > review_output.txt
          fi

      - name: Post review comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SENSITIVE="${{ steps.sensitive.outputs.found }}"
          SENSITIVE_BANNER=""
          if [ "$SENSITIVE" = "true" ]; then
            SENSITIVE_BANNER="> **SENSITIVE FILES DETECTED** - This PR touches auth, migrations, dependencies, or infrastructure files. Owner approval is REQUIRED before merge."
          fi

          {
            echo "## Claude AI Code Review"
            echo ""
            if [ -n "$SENSITIVE_BANNER" ]; then
              echo "$SENSITIVE_BANNER"
              echo ""
            fi
            cat review_output.txt
            echo ""
            echo "---"
            echo "*Automated review by Claude API. This does not replace human review.*"
          } > comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md

      - name: Request owner review for sensitive files
        if: steps.sensitive.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "requires-owner-review"
          gh pr edit ${{ github.event.pull_request.number }} --add-reviewer "${{ github.repository_owner }}"
